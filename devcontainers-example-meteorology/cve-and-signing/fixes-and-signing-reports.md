# Correção de vulnerabilidades (CVEs) e assinatura em imagens Docker

Foi utilizada nesse desafio a mesma aplicação de exemplo com ***DevContainer***, [Simple Meteorology API *(Spring Boot App)* in ***DevContainer***](../README.md).

## Comandos utilizados para build e escaneamento da imagem

Construir e taguear imagem para análise de CVEs.

- Comando para build da imagem:
    ```console
    docker build -f maven-multistage.Dockerfile -t algaworks-idk-devcontainers-examples-meteorology:security .
    ```

- Comando para Escaneamento com ***Trivy***:
    ```console
    trivy image algaworks-idk-devcontainers-examples-meteorology:security
    ```

## Antes de aplicar as correções de CVE

[**Clique aqui para visualizar o relatório completo antes das correções (/cve/before-fix-report.html).**](/cve/before-fix-report.html)

### Vunerabilidades encontradas

- Versão da imagem base: `alpine 3.22.1`
    - Total: 4 (UNKNOWN: 0, LOW: 1, MEDIUM: 2, HIGH: 1, CRITICAL: 0)

- Versão do `org.springframework:spring-core (6.2.10)` utilizado pelo `Spring Boot (3.5.5)`
    - Total: 1 (UNKNOWN: 0, LOW: 0, MEDIUM: 0, HIGH: 1, CRITICAL: 0)

- Versão do `Dockerize (0.9.3)`
    - Total: 7 (UNKNOWN: 0, LOW: 0, MEDIUM: 5, HIGH: 2, CRITICAL: 0)

## Correções de vulnerabilidades

- Referentes ao `org.springframework:spring-core (6.2.10)`
    - Atualizado o Spring Boot de `3.5.5` para `3.5.6` que utiliza o `spring-core 6.2.11` (versão corrigida).
    
- Referentes ao `alpine 3.22.1` das imagens base
    - Mudança das imagens base para versão ***Ubi-Mininal (Minimal/Distroless)***
        - Stage ***build***
            - `maven:3.9.11-eclipse-temurin-21-alpine` para `eclipse-temurin:21-jdk-ubi10-minimal`
        - Stage ***runtime***
            - `eclipse-temurin:21-alpine` para `eclipse-temurin:21-jre-ubi10-minimal`

- Referentes ao `Dockerize (0.9.3)`
    - Mudança da versão para `0.9.6` que contém apenas 01 vulnerabilidade ***MEDIUM*** referente ao `stdlib`.
    
## Após de aplicar as correções de CVE

[**Clique aqui para visualizar o relatório após as correções (/cve/after-fix-report.html).**](/cve/after-fix-report.html)

- App e suas dependências (`.jar`): `app/algaworks-idk-devcontainers-examples-meteorology-0.0.1-SNAPSHOT.jar`
    - 0 vulnerabilidades
- Imagens base (`redhat`, `ubi10-minimal`): `algaworks-idk-devcontainers-examples-meteorology:security (redhat 10.0)`
    - 0 vulnerabilidades
- Dockerize: `usr/local/bin/dockerize`
    - Total: 1 (UNKNOWN: 0, LOW: 0, MEDIUM: 1, HIGH: 0, CRITICAL: 0)

## Realizando a assinatura da imagem com ***Cosign*** com *key-based signing*

Para assinar a imagem, primeiro é necessário aplicar uma tag para apontar para nosso repositório no Registry Docker Hub
e em seguida realizar o push da imagem.

- Comando utilizado para aplicar a tag:
    ```console
    docker tag algaworks-idk-devcontainers-examples-meteorology:security leoarj/algaworks-idk-devcontainers-examples-meteorology:sign
    ```

- Comando para realizar o push:
    ```console
    docker push leoarj/algaworks-idk-devcontainers-examples-meteorology:sign
    ```

- Comando utilizado parar gerar par de chaves:
    ```console
    cosign generate-key-pair
    ````

- Comando utilizado para assinar a imagem (Usa a chave privada):
    ```console
    cosign sign --key cosign/cosign.key leoarj/algaworks-idk-devcontainers-examples-meteorology:sign
    ```

- Comando utilizado para verificação da assinatura da imagem (Usa a chave privada):
    ```console
    cosign verify --key cosign/cosign.pub index.docker.io/leoarj/algaworks-idk-devcontainers-examples-meteorology:sign | jq
    ```
    >Obs.: Com utilitário *jq* para formatação da saída em json.

- Resultado da verificação da assinatura (Usa chave pública):
    ```json
    Verification for index.docker.io/leoarj/algaworks-idk-devcontainers-examples-meteorology:sign --
    The following checks were performed on each of these signatures:
    - The cosign claims were validated
    - Existence of the claims in the transparency log was verified offline
    - The signatures were verified against the specified public key
    [
    {
        "critical": {
        "identity": {
            "docker-reference": "index.docker.io/leoarj/algaworks-idk-devcontainers-examples-meteorology"
        },
        "image": {
            "docker-manifest-digest": "sha256:9201f5d5a7cafc3b60553c1e01b8b973c5df9155d5d446c949c25d2c7f20aef2"
        },
        "type": "cosign container image signature"
        },
        "optional": {
        "Bundle": {
            "SignedEntryTimestamp": "MEUCIQCL0Idgvh+16460TfLtBcJD53yifL3t2vMjs1LXbFsTTQIgWZJmKLW1ndNMjMkFydY7cdZKEgecXORtesGBwzblo+o=",
            "Payload": {
            "body": "eyJhcGlWZXJzaW9uIjoiMC4wLjEiLCJraW5kIjoiaGFzaGVkcmVrb3JkIiwic3BlYyI6eyJkYXRhIjp7Imhhc2giOnsiYWxnb3JpdGhtIjoic2hhMjU2IiwidmFsdWUiOiJmMjQ0Y2NhOTU5NDBhNTYyNDIxMzNjMjg2NWY2MjYzYzYzOTJhYWQ3YzUzOTgwNTgxNzRiNTViMTdlZWM1YzMwIn19LCJzaWduYXR1cmUiOnsiY29udGVudCI6Ik1FWUNJUURjUVdTZk8yMDZ5VnhHMCtIK3JLeGtEN0EzSFU4bXZ1eGlrWTJpdUQ1R01BSWhBTDNpZG5nVllNUWNVbmVxYjR4WGs4U215c1JRTUN0Qk80ZExjd21NQm1MbSIsInB1YmxpY0tleSI6eyJjb250ZW50IjoiTFMwdExTMUNSVWRKVGlCUVZVSk1TVU1nUzBWWkxTMHRMUzBLVFVacmQwVjNXVWhMYjFwSmVtb3dRMEZSV1VsTGIxcEplbW93UkVGUlkwUlJaMEZGUTBsMVF6VXdTREpIYWtRck5YQjVWMlZTYWpoRGR6VjNOMUJ3UVFvM2JsQjZiR1JqVFRKSVlrd3lSM0Y0TkcwMWNTdFdNUzlqTW1WUk9TdEJNR0ptVTFkWFdVVmhSMWRQV2pGVGJpc3ZOVVpVU2pkSUwxQkJQVDBLTFMwdExTMUZUa1FnVUZWQ1RFbERJRXRGV1MwdExTMHRDZz09In19fX0=",
            "integratedTime": 1759604843,
            "logIndex": 583954035,
            "logID": "c0d23d6ad406973f9559f3ba2d1ca01f84147d8ffc5b8445c224f98b9591801d"
            }
        }
        }
    }
    ]
    ```

## Executando um container da imagem

- Executando com `docker run`
    ```console
    docker run --rm --name examples-meteorology-api \
    --net=host \
    -p 8082:8082 \
    -e DB_HOST=localhost \
    -e DB_PORT=5432 \
    -e DB_NAME=meteorology \
    -e DB_USERNAME=postgres \
    -e DB_PASSWORD=123456 \
    -e SERVER_PORT=8082 \
    leoarj/algaworks-idk-devcontainers-examples-meteorology:sign
    ```
    >Obs.: Um servidor PostgreSQL deve estar executando com as configurações informadas (Pode usar o auxílio do Makefile do projeto por exemplo).

## Referências

Foram utilizadas as seguintes referências para a remoção dos CVEs na imagem Docker da aplicação, principalmente na migração para a imagem baseada no ***Red Hat Universal Base Image (Ubi)***.

*Imagens Minimal/Distroless são imagens com foco em menor superfície de ataque (smaller surface atack), com menos componentes presentes como ferramentas de sistema, shells e gerenciadores de pacote, embora ainda não sejam em tamanho menores que uma imagem Alpine comum, ainda assim possuem menos ou zero CVEs.*

- Atualização do Spring Boot (Utiliza `org.springframework:spring-core`)
    - https://mvnrepository.com/artifact/org.springframework.boot/spring-boot/3.5.6

- Migração da imagem para para `ubi10-minimal`
    - Docker - Imagens Minimal/Distroless
        - https://docs.docker.com/dhi/core-concepts/distroless/
    - Red Hat - Universal Base Images (Ubi)
        - Introdução ao Red Hat Universal Base Image
            - https://www.redhat.com/en/blog/introducing-red-hat-universal-base-image
        - Catálogo
            - https://catalog.redhat.com/en/software/containers/ubi10/66f2a8d39bdbdc1b74e81460
        - Adicionando pacotes em um container Ubi
            - https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html/building_running_and_managing_containers/assembly_adding-software-to-a-ubi-container_building-running-and-managing-containers
        - Gerenciamento de UIDS e GID
            - https://www.redhat.com/en/blog/user-account-gid-uid
    - Passos básicos com imagens Ubi
        - https://medium.com/@tushant253/universal-base-images-ubi-a-comprehensive-analysis-and-practical-implications-473a4a00d613
    - Outras opções de imagens Distroless
        - Chainguard
            - https://images.chainguard.dev/
        - Google
            - https://github.com/GoogleContainerTools/distroless
        - Microsoft
            - https://learn.microsoft.com/en-us/java/openjdk/containers
            - https://mcr.microsoft.com/en-us/artifact/mar/openjdk/jdk/tags

- Atualização do ***Dockerize***
    - https://github.com/jwilder/dockerize/releases/tag/v0.9.6
